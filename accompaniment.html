<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- Preconnect to resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//www.google-analytics.com">
    <link rel="dns-prefetch" href="//www.googletagmanager.com">
    <link rel="preconnect" href="//cdn.jsdelivr.net">
    <link rel="preconnect" href="//disqus.com">
    <link rel="preconnect" href="//referrer.disqus.com">
    <link rel="preconnect" href="//a.disquscdn.com">
    <link rel="preconnect" href="//c.disquscdn.com">

    

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">

    <!-- Metadata for Atom/RSS feed -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Aidan's Research Blog" />

    <!-- jekyll-seo tag -->
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Generating Musical Accompaniment with a Variational Autoencoder | Aidan’s Research Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Generating Musical Accompaniment with a Variational Autoencoder" />
<meta name="author" content="Aidan Swope" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="With a model trained to compress multi-instrument music into latent codes, and a second model that predicts these codes given just one instrument, we can add drums and bass to any melody." />
<meta property="og:description" content="With a model trained to compress multi-instrument music into latent codes, and a second model that predicts these codes given just one instrument, we can add drums and bass to any melody." />
<link rel="canonical" href="http://localhost:4000/accompaniment" />
<meta property="og:url" content="http://localhost:4000/accompaniment" />
<meta property="og:site_name" content="Aidan’s Research Blog" />
<meta property="og:image" content="http://localhost:4000/assets/pages/posts/accompaniment/accompany-teaser.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-09T00:00:00-07:00" />
<script type="application/ld+json">
{"description":"With a model trained to compress multi-instrument music into latent codes, and a second model that predicts these codes given just one instrument, we can add drums and bass to any melody.","headline":"Generating Musical Accompaniment with a Variational Autoencoder","dateModified":"2020-08-09T00:00:00-07:00","datePublished":"2020-08-09T00:00:00-07:00","@type":"BlogPosting","image":"http://localhost:4000/assets/pages/posts/accompaniment/accompany-teaser.png","url":"http://localhost:4000/accompaniment","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/accompaniment"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/android-chrome-512x512.png"},"name":"Aidan Swope"},"author":{"@type":"Person","name":"Aidan Swope"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- Link fonts and stylesheets -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,350;0,600;1,350&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
      <link rel="stylesheet" href="/assets/pages/posts/accompaniment/style.css" async>
    

  <body>
    <div class="page-wrapper">
      <header>
  <nav>
    <a href="/" id="nav-home">
      Aidan's Research Blog
    </a>

    <ul>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/tags">Tags</a></li>
    
    </ul>
  </nav>
</header>

<main>
  <article>
    <h1>Generating Musical Accompaniment with a Variational Autoencoder</h1>
    <p id="writing-date">Posted on 09 August 2020</p>
    <div id="writing-summary"><p>With a model trained to compress multi-instrument music into latent codes, and a second model that predicts these codes given just one instrument, we can add drums and bass to any melody.
</p></div>

    <ul class="tag-list-inline">
  
    <li class="tag-default">
      <a href="/tags#project">
        <!-- "tag" icon from https://heroicons.dev/ -->
        <svg fill="currentColor" viewBox="0 0 20 20" width=1em><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
         Project
      </a>
    </li>
  
    <li class="tag-default">
      <a href="/tags#generative-models">
        <!-- "tag" icon from https://heroicons.dev/ -->
        <svg fill="currentColor" viewBox="0 0 20 20" width=1em><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
         Generative Models
      </a>
    </li>
  


  
  <li class="tag-poster">
    <a href="https://drive.google.com/file/d/1SYW0uhId39YXQMXmvfQQf49A6d1J4ooF/view?usp=sharing">
        <!-- "chart-square-bar" icon from https://heroicons.dev/ -->
      <svg fill="currentColor" viewBox="0 0 20 20" width=1em><path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm9 4a1 1 0 10-2 0v6a1 1 0 102 0V7zm-3 2a1 1 0 10-2 0v4a1 1 0 102 0V9zm-3 3a1 1 0 10-2 0v1a1 1 0 102 0v-1z" clip-rule="evenodd"></path></svg>
      Poster
    </a>
  </li>
  

  

  
  <li class="tag-code">
    <a href="https://github.com/maxwells-daemons/accompany-music-vae">
      <!-- terminal icon from https://heroicons.dev/ -->
      <svg fill="currentColor" viewBox="0 0 20 20" width=1em><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
      Code
    </a>
  </li>
  
</ul>


    <hr>

    <div class="content-wrapper">
    
    <nav id="toc-nav">
      <h3 id="toc-header">Contents</h3>
      <ul id="table-of-contents">
  <li><a href="#overview">Model Overview</a></li>
  <li><a href="#latents-and-vaes">Variational Autoencoders and Latent Space</a></li>
  <li><a href="#predicting-latents">Predicting Latent Variables from a Melody</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#footnotes">Footnotes</a></li>
</ul>

    </nav>
    

    <p>
<em>
This was the final project for
<a href="https://sites.google.com/view/cs-159-spring-2019">an undergraduate class on deep probabilistic models</a>, and was built with
<a href="https://www.linkedin.com/in/brendan-hollaway">Brendan Hollaway</a>,
<a href="https://www.linkedin.com/in/anthonybao">Anthony Bao</a>, and
<a href="https://github.com/HSQ8">Hongsen Qin</a>.
</em>
</p>

<p>
Generative machine learning models have famously been used to create new media from scratch, but an even more exciting possibility involves humans collaborating with algorithms throughout the creative process.<span class="footnote" id="footnote-1-inline"><a href="#footnote-1"><sup>1</sup></a><span class="footnote-inner">A <a href='https://distill.pub/2017/aia/'>really cool article</a> by Shan Carter and Michael Nielsen discusses in much greater depth the idea of &ldquo;artificial intelligence augmentation&rdquo; through interacting with generative models.</span></span>

While generative models are increasingly able to generate convincing images, audio, and text, human input is valuable to choose properties we want the final result to have and to incorporate parts of the human experience we haven't (yet) been able to train our models to understand.
</p>

<p>
This project explores co-composing music with a neural network that automatically generates drums and bass for a human-written melody.
You can listen to some samples from our model below:
</p>

<p class="song-title">Tetris Theme</p>
<div class="song-wrapper">
  <div class="sample-wrapper">
    <audio controls preload=auto>
      <source src="/assets/pages/posts/accompaniment/audio/tetris-accompaniment.mp3">
      Your browser does not support the audio element.
    </audio>
    <p>Generated</p>
  </div>

  <div class="sample-wrapper">
    <audio controls preload=auto>
      <source src="/assets/pages/posts/accompaniment/audio/tetris-original.mp3">
      Your browser does not support the audio element.
    </audio>
    <p>Original</p>
  </div>
</div>

<p class="song-title">Nyan Cat</p>
<div class="song-wrapper">
  <div class="sample-wrapper">
    <audio controls preload=auto>
      <source src="/assets/pages/posts/accompaniment/audio/nyan-cat-accompaniment.mp3">
      Your browser does not support the audio element.
    </audio>
    <p>Generated</p>
  </div>

  <div class="sample-wrapper">
    <audio controls preload=auto>
      <source src="/assets/pages/posts/accompaniment/audio/nyan-cat-original.mp3">
      Your browser does not support the audio element.
    </audio>
    <p>Original</p>
  </div>
</div>

<p class="song-title">In the Hall of the Mountain King</p>
<div class="song-wrapper">
  <div class="sample-wrapper">
    <audio controls preload=auto>
      <source src="/assets/pages/posts/accompaniment/audio/in-the-hall-of-the-mountain-king-accompaniment.mp3">
      Your browser does not support the audio element.
    </audio>
    <p>Generated</p>
  </div>

  <div class="sample-wrapper">
    <audio controls preload=auto>
      <source src="/assets/pages/posts/accompaniment/audio/in-the-hall-of-the-mountain-king-original.mp3">
      Your browser does not support the audio element.
    </audio>
    <p>Original</p>
  </div>
</div>

<p>
While this project uses a restricted subset of MIDI
(which is itself very restricted relative to all of what's possible with music),
and the samples therefore always sound a little elevator&#8209;music&#8209;y,
we believe that this approach would scale well to larger,
more sophisticated latent variable models, such as
<a href="">OpenAI's Jukebox</a>.
</p>

<h2 id="overview">Model Overview</h2>
<p>
Before getting into the details, here's a brief overview of how the model works at a high level.
</p>

<img
  alt="A diagram of the training and inference procedure"
  class="lazy"
  data-src="/assets/pages/posts/accompaniment/accompany-training.svg"
  width="1450px"
  height="auto" />

<p>
The core of the model is <a href="https://magenta.tensorflow.org/music-vae">MusicVAE</a>, a pretrained model created by <a href="https://magenta.tensorflow.org/">Magenta</a>.
MusicVAE consists of an encoder, which transforms pieces of music into latent variables which capture properties of that music in a simpler compressed form, and a decoder which transforms latent variables back into music.
Both the encoder and the decoder are trained on three-track MIDI consisting of melody, drums, and bass, with extra features like time signature changes stripped.<span class="footnote" id="footnote-2-inline"><a href="#footnote-2"><sup>2</sup></a><span class="footnote-inner">As a result, the model doesn't work very well on music using these features.</span></span>

</p>

<p>
Because we want to generate the accompaniment given a new melody, we train a &ldquo;surrogate encoder&rdquo; to mimic the original MusicVAE encoder, while only having access to the melody.
Given a dataset of three-track music, we use the MusicVAE encoder to produce a latent representation for each song, then strip out the drums and bass and train the surrogate encoder to predict the latent variables from the melody alone.
Finally, given a new melody, we use the surrogate encoder to guess what the latent variables might be for the melody's (nonexistant!) three-track song, pass those latent variables to the MusicVAE decoder to turn into three-track MIDI, and stitch the original melody back in.
</p>

<h2 id="latents-and-vaes">Variational Autoencoders and Latent Space</h2>
<p>
MusicVAE is a variational autoencoder (or VAE). A full tutorial on VAEs is outside of the scope of this project writeup, but for an introduction I recommend <a href="https://jaan.io/what-is-variational-autoencoder-vae-tutorial/">Jaan Altosaar's tutorial</a>.
For the purposes of this project, you can think of a variational autoencoder as a way of representing your data in a simpler and smaller way, as a collection of latent variables.
In our case, a MIDI song might take 20 KB to store, but its latent representation is a vector of 512 floating-point numbers, a compression ratio of ten.
Despite being much smaller, the latent variables are expected to capture most of the high-level properties of the music, like genre, key, time, and timings for particular events.
This is possible because music has patterns that enable it to be described succinctly &mdash; you could get a passable reconstruction of some drum parts by just asking a drummer to &ldquo;play a swing beat.&rdquo;
</p>

<p>
Furthermore, latent representations are presumed to live in some &ldquo;latent space,&rdquo; about which we make some very strong assumptions.
The latent space is expected to be smooth, in the sense that two nearby (512-dimensional) points are expected to represent two songs that sound very similar.<span class="footnote" id="footnote-3-inline"><a href="#footnote-3"><sup>3</sup></a><span class="footnote-inner">The two songs may not have any notes in common, though! Distances and directions are more meaningful in latent space than they are in data space.</span></span>

Directions are often meaningful in latent space; the authors of MusicVAE found that <a href="https://magenta.tensorflow.org/music-vae#long-term-structure">they could move songs in an &ldquo;add note density&rdquo; direction</a> to maintain the character of a song but with more notes.
</p>

<p>
Most importantly, the latent space has a squished and twisted shape (relative to the data's shape) such that real music appears Gaussian-distributed in this space.<span class="footnote" id="footnote-4-inline"><a href="#footnote-4"><sup>4</sup></a><span class="footnote-inner">This is actually an oversimplification. While ours is Gaussian, VAEs often use other distributions for the latent space.</span></span>

This means that when you sample latent vectors from a Gaussian, they likely correspond to songs that sound reasonable, and conversely real songs frequently map to vectors near the origin.
If you were to pick any direction in latent space, find the latent vector corresponding to every popular song and project those vectors onto this direction, then plot a histogram of the resulting values, that histogram should form a standard normal bell curve.
</p>

<p>
Latent space is very simple (it's just a multivariate Gaussian), but it's supposed to represent the full distribution of music, which is complex and multimodal in its common representations (MIDI, MP3, FLAC, etc.).
To accomplish this, a variational autoencoder employs two powerful neural networks to translate between data space and latent space.
The encoder maps data points into latent variables that represent them, and the decoder maps latent variables back into data space.
By randomly sampling points in latent space and pushing them through a good decoder, we can generate endless music, or images, or whatever else the VAE was trained on.
What is most remarkable is that variational autoencoders are trained <em>unsupervised</em>.
Given a dataset of media, the encoder and decoder learn to create this very special latent space with no additional supervision.
</p>

<h2 id="predicting-latents">Predicting Latent Variables from a Melody</h2>

<p>
A lot of the things we want our latent variables to capture &mdash; what the song's genre is, when solos start and end, etc. &mdash; are present in all three parts of the original music.
When a bass solo starts, the drummer might play a simpler pattern and the melody might stop playing altogether.
When it ends, the drummer doesn't need to know much about the details of the solo to play an appropriate fill.
In this sense, the original music is an <em>overcomplete representation</em>, which is why we're able to compress it so much in the latent space.
</p>

<img
  alt="A graph of the notes in Frank Sinatra's 'New York, New York' and its reconstruction from the melody alone"
  class="lazy"
  data-src="/assets/pages/posts/accompaniment/new-york-new-york.jpg"
  width="1094px"
  height="auto" />

<p>
That also means that many properties of a full song's latent representation can be inferred from just one of the parts.
In the plot above, the surrogate encoder and MusicVAE decoder try to reconstruct the theme from &ldquo;New York, New York&rdquo; from just Frank Sinatra's part.
Red bars are the melody, blue are the bass, and brown are drums.
The model certainly can't predict the original accompaniment, and it doesn't even recreate the melody (which the surrogate encoder has access to) &mdash; that's why we stitch the original melody back in as the last step.
However, it has correctly inferred a swing beat for the drums, works around important timings in the song, and plays the bass in key.
This means that the original MusicVAE encoder learned to encode properties like drum style in the latent space in a simple way, and our surrogate encoder was able to map from the melody to the latent variables that MusicVAE used to represent these properties.
</p>

<h2 id="conclusion">Conclusion</h2>
<p>
Variational autoencoders have been pretty unpopular recently, due to the dominance of GANs on many of the same generative tasks.
However, with some impressive recent results generating <a href="https://arxiv.org/pdf/1906.00446.pdf">high-resolution images</a> and <a href="https://openai.com/blog/jukebox/">raw audio</a> with more sophisticated VAEs, variational methods are making something of a comeback.
Hopefully this post illustrates some of the cool things you can do with an explicit and controllable latent space.
</p>

<p>
If you like, check out the code and some additional samples on <a href="https://github.com/maxwells-daemons/accompany-music-vae">the GitHub repo</a>.
And if you find any mistakes, errors, or points of confusion, please let me know!
</p>

<h2 id="footnotes">Footnotes</h2>
<ol>
  <li class="footnote-bottom">
  <span id="footnote-1">A <a href='https://distill.pub/2017/aia/'>really cool article</a> by Shan Carter and Michael Nielsen discusses in much greater depth the idea of &ldquo;artificial intelligence augmentation&rdquo; through interacting with generative models.</span> <a href="#footnote-1-inline">↩</a>
</li>

  <li class="footnote-bottom">
  <span id="footnote-2">As a result, the model doesn't work very well on music using these features.</span> <a href="#footnote-2-inline">↩</a>
</li>

  <li class="footnote-bottom">
  <span id="footnote-3">The two songs may not have any notes in common, though! Distances and directions are more meaningful in latent space than they are in data space.</span> <a href="#footnote-3-inline">↩</a>
</li>

  <li class="footnote-bottom">
  <span id="footnote-4">This is actually an oversimplification. While ours is Gaussian, VAEs often use other distributions for the latent space.</span> <a href="#footnote-4-inline">↩</a>
</li>

</ol>



    
    <hr>
<p>Cite as:</p>
<div id="citation">
<figure class="highlight"><pre><code class="language-language-plaintext" data-lang="language-plaintext">@misc{‎swopeHollawayBaoQin2020accompaniment,
  title   = "Generating Musical Accompaniment with a Variational Autoencoder",
  author  = "Swope, Aidan and Hollaway, Brendan and Bao, Anthony and Qin, Hongsen",
  journal = "aidanswope.com",
  year    = "2020",
  url     = "http://localhost:4000/accompaniment"
}</code></pre></figure>
</div>

    
    </div>
  </article>

  <!-- Disqus embed code -->
  
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
    this.page.url = "http://localhost:4000/accompaniment";
    this.page.identifier = "/accompaniment";
  };
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://aidans-research-blog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  
</main>

      <footer>
  © 2020 Aidan Swope
</footer>

    </div>

  <!-- Lazy-load below-the-fold content with vanilla-lazyload -->
  <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
  <script>
    var lazyLoadInstance = new LazyLoad({});
  </script>
  </body>
</html>
